---
title: "Rによる二次分析入門：事前課題"
subtitle: "セミナー当日までに確認していただきたいこと"
author: "藤原翔（東京大学）"
date: today
date-format: long
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    embed-resources: true
    theme: cosmo
lang: ja
---

# はじめに

本資料は「Rによる二次分析入門」セミナーの事前課題です。当日スムーズに分析に入れるよう、以下の準備をセミナー前日までに完了してください。

**所要時間の目安**：1〜2時間（ダウンロード時間を除く）

::: {.callout-important}
## 準備ができない場合
インストールやデータの準備でうまくいかない場合は、事前にメール（sho.fujihara@iss.u-tokyo.ac.jp）でご連絡ください。当日の開始前にサポートします。
:::

# R・RStudioのインストール

{{< video https://youtu.be/-2HfYK1ow6A >}}

## Rのインストール

1. [CRAN](https://cran.r-project.org/) にアクセス
2. 自分のOSに合ったリンクをクリック
   - **Windows**：「Download R for Windows」→「base」→「Download R-4.x.x for Windows」をクリック
   - **Mac**：「Download R for macOS」→ 以下のいずれかを選択
     - **Apple Silicon（M1〜M4）Mac**の場合：`arm64` と書かれた `.pkg` ファイル
     - **Intel Mac**の場合：`x86_64` と書かれた `.pkg` ファイル
3. ダウンロードしたファイルを実行してインストール（設定はすべてデフォルトのままでOK）

::: {.callout-tip}
## 自分のMacの種類を確認する方法
画面左上のリンゴマーク →「このMacについて」→「チップ」の項目を確認してください。「Apple M1」「Apple M2」などと表示されればApple Silicon、「Intel」と表示されればIntel Macです。
:::

## RStudioのインストール

1. [Posit社のダウンロードページ](https://posit.co/download/rstudio-desktop/) にアクセス
2. 「RStudio Desktop Free」の「Download」をクリック
3. 自分のOSに合ったインストーラをダウンロードして実行

::: {.callout-warning}
## インストール時のセキュリティ警告
- **Windows**：「WindowsによってPCが保護されました」と表示された場合 →「詳細情報」→「実行」をクリックしてください
- **Mac**：「開発元を確認できないため開けません」と表示された場合 → アプリを右クリック（またはControl+クリック）→「開く」を選択してください。それでも開けない場合は「システム設定」→「プライバシーとセキュリティ」から実行を許可してください
:::

## RStudioの起動確認

RStudioを起動すると @fig-RStudio のような画面が表示されます。

![RStudioの画面](figures/RStudio.png){#fig-RStudio}

画面には4つの領域（pane）があります：

- **左上（Source）**：スクリプトを編集する場所
- **左下（Console）**：結果が表示される場所
- **右上（Environment）**：作成したオブジェクトを確認する場所
- **右下（Output）**：ファイル、図、ヘルプなどが表示される場所

::: {.callout-tip}
## Paneの配置変更
@fig-pane の赤枠部分からPaneの配置を変更できます。「Console on Right」を選択すると、コンソールが右上に移動します。好みに応じて設定してください。

![Paneの設定](figures/pane.png){#fig-pane}
:::


# プロジェクトの作成

{{< video https://youtu.be/DD6Yt2yTTzo >}}

RStudioでは**プロジェクト**を使ってファイルを管理します。分析ごとにプロジェクトを作成することで、ファイルの管理が楽になります。

## 新規プロジェクトの作成

1. RStudioのメニューから「File」→「New Project...」を選択
2. 「New Directory」を選択
3. 「New Project」を選択
4. 以下を設定：
   - **Directory name**：`benesse_seminar`（プロジェクト名）
   - **Create project as subdirectory of**：保存先を選択（デスクトップやDocumentsなど分かりやすい場所）
5. 「Create Project」をクリック

::: {.callout-warning}
## フォルダのパスに日本語を含めない
保存先のパスに日本語が含まれると、ファイルの読み込みでエラーが起きることがあります。例えば `C:/Users/田中/デスクトップ/benesse_seminar` のようなパスは避け、`C:/Users/tanaka/Desktop/benesse_seminar` のように英数字のパスを選んでください。
:::

## フォルダ構成の作成

プロジェクトフォルダ内に、以下のフォルダを作成してください：

```
benesse_seminar/
├── benesse_seminar.Rproj
├── data/
│   ├── raw/          # 元データ
│   │   ├── 1571/     # メインのパネルデータ
│   │   ├── 1577/     # 2016年度語彙力・読解力調査
│   │   └── 1578/     # 2019年度語彙力・読解力調査
│   └── processed/    # 加工済みデータ
├── scripts/          # Rスクリプト
├── figures/          # 図
└── tables/           # 表
```

RStudioの右下ペインの「Files」タブから「New Folder」でフォルダを作成できます。

あるいは、以下のRコードを実行してフォルダを一括作成することもできます：

```{r}
#| eval: false
# フォルダを作成
dir.create("data/raw/1571", recursive = TRUE)
dir.create("data/raw/1577", recursive = TRUE)
dir.create("data/raw/1578", recursive = TRUE)
dir.create("data/processed", recursive = TRUE)
dir.create("scripts", recursive = TRUE)
dir.create("figures", recursive = TRUE)
dir.create("tables", recursive = TRUE)
```


# パッケージのインストール

{{< video https://youtu.be/nCHCQUbROyw >}}

Rでは「パッケージ」を追加することで機能を拡張できます。セミナーで使用するパッケージを事前にインストールしてください。

以下のコードをRStudioのコンソールに貼り付けて実行してください：

```{r}
#| eval: false
# 必要なパッケージのインストール
install.packages(c(
  "tidyverse",    # データ操作・可視化（dplyr, ggplot2など）
  "haven",        # Stata/SPSSファイルの読み込み
  "here",         # ファイルパスの管理
  "janitor",      # データクリーニング
  "modelsummary", # 回帰分析の結果表示
  "fixest",       # 固定効果モデル
  "marginaleffects", # 限界効果の計算
  "broom",        # モデル結果の整形
  "ggalluvial",   # Sankey図
  "scales"        # 軸ラベルの書式設定
))
```

::: {.callout-note}
## インストールに時間がかかる場合
初めてのインストールでは数分〜10分程度かかることがあります。「パッケージをソースからインストールしますか？」と聞かれたら「No」を選択してください。
:::

インストールが完了したら、以下のコードでパッケージが正しく読み込めるか確認してください：

```{r}
#| eval: false
# パッケージの読み込みテスト
library(tidyverse)
library(haven)
library(here)
```

エラーが出なければ成功です。


# データのダウンロードと配置

## データの入手

セミナーで使用するデータは、東京大学社会科学研究所附属社会調査・データアーカイブ研究センター（CSRDA）のSSJDAが提供するものです。

::: {.callout-note}
## データ利用について
本セミナーのみでの利用の場合は、個人での申請は必要ありません。セミナー用にデータを配布します。

ただし、本セミナーを発展させて研究として分析し発表したい場合は、SSJDAへの個人での申請をお願いします。

- [SSJDAウェブサイト](https://csrda.iss.u-tokyo.ac.jp/)
:::

ダウンロードするデータ：

1. **1571**：子どもの生活と学びに関する親子調査（メインのパネルデータ）
2. **1577**：2016年度語彙力・読解力調査
3. **1578**：2019年度語彙力・読解力調査

## データの配置

ダウンロードしたzipファイルを展開し、以下のように配置してください（Windowsの場合はzipファイルを右クリック →「すべて展開」、Macの場合はダブルクリックで展開できます）。

- `1571.dta`（または`1571.csv`）→ `data/raw/1571/` フォルダ内
- `1577.dta`（または`1577.csv`）→ `data/raw/1577/` フォルダ内
- `1578.dta`（または`1578.csv`）→ `data/raw/1578/` フォルダ内

::: {.callout-tip}
## ラベル情報が必要な場合
`.dta`（Stata形式）ファイルにはラベル情報が含まれているため、こちらの使用を推奨します。`.csv`ファイルにはラベル情報が含まれていません。
:::


# データ読み込みの確認

{{< video https://youtu.be/ZoUGupgbKpg >}}

データが正しく配置できたか確認します。以下のコードを実行してください：

```{r}
#| eval: false
# パッケージの読み込み
library(tidyverse)
library(haven)
library(here)

# データの読み込み
# here() はプロジェクトフォルダを基準にパスを組み立てる関数
d <- haven::read_dta(here("data", "raw", "1571", "1571.dta"))

# データの確認
glimpse(d)
```

以下のように、データの行数・列数と各変数の名前・型・最初の数値が表示されれば成功です。

```
Rows: 21,569
Columns: 2,961
$ PanelID          <dbl> 1600001, 1600002, 1600003, ...
$ w1調査フラグ     <dbl> 1, 1, 1, ...
...
```

## 読み込みがうまくいかない場合

### ファイルが見つからないエラー

```
Error: 'data/raw/1571/1571.dta' does not exist.
```

→ ファイルのパスが間違っている可能性があります。以下を確認してください：

- プロジェクトフォルダの直下に`data`フォルダがあるか
- `data/raw/1571/`フォルダ内に`1571.dta`ファイルがあるか

### Import Datasetを使う方法

コードでの読み込みがうまくいかない場合は、RStudioのメニューから読み込む方法もあります。

1. 「File」→「Import Dataset」→「From Stata...」を選択
2. 「Browse」からファイルを選択
3. 右下の「Data Frame」でデータが正しく表示されていることを確認
4. 「Import」をクリック

![Import Dataset（haven）の画面例](figures/read_stata_benesse.png){#fig-read_stata}


# Rの基本操作（任意）

{{< video https://youtu.be/9IELKx_ir3E >}}

{{< video https://youtu.be/zKgxQQlmjfo >}}

時間があれば、以下の基本操作も試してみてください。

## スクリプトの作成

@fig-script の赤枠部分からRスクリプトを新規作成できます。

![スクリプトを開く](figures/script.png){#fig-script}

## 計算の実行

スクリプトにコードを入力し、「Ctrl + Enter」（Macは「Cmd + Enter」）で実行します。

```{r}
# 足し算
1 + 1

# 掛け算
7 * 8

# 平方根
sqrt(16)
```

## オブジェクトへの代入

Rでは、値や計算結果に名前をつけて保存できます。この「名前をつけた入れ物」を**オブジェクト**と呼びます。`<-`（代入演算子）を使って、右側の値を左側の名前に代入します。

```{r}
# xに10を代入
x <- 10
x

# ベクトル（複数の値）を代入
y <- c(1, 2, 3, 4, 5)
y

# 平均を計算
mean(y)
```

::: {.callout-tip}
## オブジェクトの確認
作成したオブジェクトは、RStudio右上の「Environment」ペインで確認できます。オブジェクト名を入力して実行すると、その中身が表示されます。
:::

::: {.callout-note}
## オブジェクトを活用するメリット
オブジェクトを活用することで、効率的な分析が可能になります：

- **再利用**：一度読み込んだデータや計算結果を何度でも使える
- **可読性**：`mean(income)`のように、何を計算しているか分かりやすくなる
- **修正が容易**：データの前処理を修正しても、後続の分析コードを変更する必要がない
- **再現性**：スクリプトを実行すれば、同じ結果を何度でも再現できる
:::


# チェックリスト

セミナー当日までに、以下が完了していることを確認してください：

- [ ] R・RStudioがインストールされている
- [ ] RStudioが正常に起動する
- [ ] `benesse_seminar`プロジェクトが作成されている
- [ ] フォルダ構成（data/raw, data/processed, scripts, figures, tables）が作成されている（難しければセミナー当日に一緒に作成します）
- [ ] 必要なパッケージがインストールされている
- [ ] `library(tidyverse)` がエラーなく実行できる
- [ ] データファイルが正しい場所に配置されている
- [ ] データの読み込みが成功する

すべてにチェックがついたら準備完了です。当日お会いできることを楽しみにしています。


# 困ったときは

## よくあるエラーと対処法

### パッケージのインストールでエラーが出る

```r
# CRANのミラーを明示的に指定してみる
install.packages("tidyverse", repos = "https://cran.rstudio.com/")
```

### 日本語のファイルパスで問題が起きる

プロジェクトの保存先を変更してください（→「[プロジェクトの作成](#プロジェクトの作成)」の注意を参照）。

## 参考動画

Rの基礎についてさらに学びたい方は、以下の動画も参考にしてください。

- [自分で関数を作る](https://youtu.be/dhHGNr-3qdA)（3:46）
- [変数からデータを作成する方法](https://youtu.be/kNx_Mjv8FGI)（5:35）
- [パイプ演算子](https://youtu.be/L5dac9sXm3c)（25:20）
- [RStudio Cloudの設定](https://youtu.be/JDC1sY_bouA)（8:27）

## 参考リンク

- [R公式サイト](https://www.r-project.org/)
- [RStudio公式サイト](https://posit.co/products/open-source/rstudio/)
- [R for Data Science（英語・無料）](https://r4ds.hadley.nz/)
- [私たちのR：ベストプラクティスの探究（日本語・無料）](https://www.jaysong.net/RBook/)
